# NEO Orbital Mechanics Calculation Guide

## Overview
This document explains how Near-Earth Object (NEO) positions are calculated in 3D Cartesian space using classical orbital mechanics and Keplerian orbital elements.

## Input Parameters (Orbital Elements)

The following orbital elements are provided from NASA's NEO database:

- **`a_km`** - Semi-major axis (km): Half the longest diameter of the orbital ellipse
- **`e`** - Eccentricity: Shape of the orbit (0 = circular, <1 = elliptical)
- **`i_deg`** - Inclination (degrees): Tilt of the orbital plane relative to Earth's orbital plane
- **`raan_deg`** - Right Ascension of Ascending Node (Ω, degrees): Where the orbit crosses Earth's orbital plane going upward
- **`argp_deg`** - Argument of Periapsis (ω, degrees): Orientation of the ellipse within its plane
- **`M_deg`** - Mean Anomaly (degrees): Position of the NEO along its orbit at epoch
- **`epoch_tdb`** - Epoch time (TDB seconds): Reference time for the orbital elements

## Step-by-Step Calculation Process

### 1. Calculate Derived Orbital Parameters

#### Orbital Period (Kepler's Third Law)
The time it takes for the NEO to complete one orbit:

```
P = 2π × √(a³ / (G × M))
```

Where:
- `P` = Orbital period (seconds)
- `a` = Semi-major axis (meters)
- `G` = Gravitational constant = 6.67430 × 10⁻¹¹ m³·kg⁻¹·s⁻²
- `M` = Mass of the Sun = 1.989 × 10³⁰ kg

#### Mean Motion
Angular velocity of the orbit:

```
n = 2π / P
```

Where `n` is in radians per second.

#### Perihelion Distance
Closest approach to the Sun:

```
q = a × (1 - e)
```

#### Aphelion Distance
Farthest distance from the Sun:

```
Q = a × (1 + e)
```

### 2. Calculate Position at Time `t`

#### 2.1 Mean Anomaly at Time `t`
Update the mean anomaly from the epoch:

```
M(t) = M₀ + n × (t - t₀)
```

Where:
- `M(t)` = Mean anomaly at time t (radians)
- `M₀` = Mean anomaly at epoch (converted to radians)
- `n` = Mean motion (radians/second)
- `t` = Current time (seconds)
- `t₀` = Epoch time (seconds)

Normalize `M(t)` to the range [0, 2π].

#### 2.2 Solve Kepler's Equation
Find the eccentric anomaly `E` by solving:

```
M = E - e × sin(E)
```

This transcendental equation is solved using the **Newton-Raphson iterative method**:

```
E(n+1) = E(n) - (E(n) - e × sin(E(n)) - M) / (1 - e × cos(E(n)))
```

Start with `E₀ = M` and iterate until convergence (typically |ΔE| < 10⁻⁶).

#### 2.3 Calculate True Anomaly
Convert eccentric anomaly to true anomaly `ν`:

```
ν = 2 × atan2(√(1 + e) × sin(E/2), √(1 - e) × cos(E/2))
```

The true anomaly represents the actual angle from periapsis to the NEO.

### 3. Convert to 3D Cartesian Coordinates

#### 3.1 Position in Orbital Plane (2D)
First, calculate position in the orbital plane coordinate system:

```
r = a × (1 - e²) / (1 + e × cos(ν))
x' = r × cos(ν)
y' = r × sin(ν)
z' = 0
```

Where `r` is the distance from the Sun.

#### 3.2 Rotate to Heliocentric Coordinates (3D)
Apply three rotation transformations to convert from the orbital plane to heliocentric coordinates:

**Rotation matrices applied in order:**
1. Rotate by argument of periapsis (ω) in the orbital plane
2. Rotate by inclination (i) to tilt the plane
3. Rotate by RAAN (Ω) to orient the ascending node

**Combined transformation:**

```
x = (cos(Ω)cos(ω) - sin(Ω)sin(ω)cos(i)) × x' + 
    (-cos(Ω)sin(ω) - sin(Ω)cos(ω)cos(i)) × y'

y = (sin(Ω)cos(ω) + cos(Ω)sin(ω)cos(i)) × x' + 
    (-sin(Ω)sin(ω) + cos(Ω)cos(ω)cos(i)) × y'

z = (sin(ω)sin(i)) × x' + (cos(ω)sin(i)) × y'
```

Result: **Position vector (x, y, z) in heliocentric Cartesian coordinates (km)**

### 4. Scaling to Godot Units

To fit the orbital visualization within Godot's scene:

```
scale_factor = 5.0 / aphelion_distance_km
godot_position = real_position_km × scale_factor
```

This maps the entire orbit to a 5-unit radius sphere in Godot.

## Coordinate System

**Heliocentric Ecliptic Coordinate System:**
- Origin: Center of the Sun
- XY-plane: Earth's orbital plane (ecliptic)
- X-axis: Points toward the vernal equinox
- Z-axis: Perpendicular to ecliptic (north)

**Earth's position:** Approximately at (1 AU, 0, 0) = (149,597,870.7 km, 0, 0)

## Trajectory Visualization

The complete orbital path is generated by:
1. Sampling 360 points around one complete orbit
2. Calculating position at each time step: `t = epoch + (i/360) × orbital_period`
3. Connecting points with a line strip using ImmediateMesh
4. Scaling all points to Godot units

## Time Simulation

The NEO's position updates in real-time:

```
simulation_time += delta × time_scale
position = get_position_at_time(simulation_time)
```

Where `time_scale` controls simulation speed (default: 86,400 seconds = 1 day per frame).

## References

- **Kepler's Laws of Planetary Motion**
- **Orbital Mechanics for Engineering Students** by Howard Curtis
- **NASA JPL Small-Body Database**
- **Two-Body Problem** in celestial mechanics

## Constants Used

| Constant | Value | Unit |
|----------|-------|------|
| Gravitational Constant (G) | 6.67430 × 10⁻¹¹ | m³·kg⁻¹·s⁻² |
| Solar Mass (M☉) | 1.989 × 10³⁰ | kg |
| Astronomical Unit (AU) | 149,597,870.7 | km |
| Seconds per Day | 86,400 | seconds |
| Days per Year | 365.25 | days |

## Implementation Notes

- All angles are converted from degrees to radians for calculations
- Newton-Raphson iteration typically converges in 5-10 iterations
- Maximum iteration limit set to 100 to prevent infinite loops
- Tolerance for Kepler's equation: 10⁻⁶ radians
- Earth is placed at a fixed position (1 AU, 0, 0) for reference

---

*This implementation uses classical orbital mechanics assuming a two-body problem (Sun and NEO), which is accurate for most NEO trajectory calculations.*
